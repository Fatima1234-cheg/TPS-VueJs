rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users: readable by everyone, writable by owner
    match /Users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update, delete: if request.auth != null && request.auth.uid == userId;
    }

    // Discussions: anyone authenticated can create; reads public; edits/deletes only by author or moderator
    match /Discussions/{docId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && (resource.data.authorId == request.auth.uid || isModerator(request.auth.uid));
    }

    // Responses
    match /Responses/{respId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && (resource.data.authorId == request.auth.uid || isModerator(request.auth.uid));
    }

    // Flags (reports) - created by authenticated users, readable by moderators
    match /Flags/{flagId} {
      allow create: if request.auth != null;
      allow read: if isModerator(request.auth.uid);
      allow delete: if isModerator(request.auth.uid);
    }

    function isModerator(uid) {
      return exists(/databases/$(database)/documents/Users/$(uid)) && get(/databases/$(database)/documents/Users/$(uid)).data.role == 'moderator';
    }
  }
}
